schema: '2.0'
stages:
  synthetic_data:
    cmd: python -m synthetic_data.generate --params params.yaml
    deps:
    - path: synthetic_data/clients.py
      hash: md5
      md5: 56336e8b88bb4ebc5856311765aa3a44
      size: 3181
    - path: synthetic_data/data/seed_titles.csv
      hash: md5
      md5: 6025c97194c1f1e76f07c1c6bdd89a4d
      size: 410892
    - path: synthetic_data/generate.py
      hash: md5
      md5: d918dfa1911913d0daecf2a320cc202b
      size: 11132
    - path: synthetic_data/models.py
      hash: md5
      md5: 867b1f88b98e5b6a355ab6eedab00abd
      size: 598
    params:
      params.yaml:
        synthetic_data:
          model: gpt-5-mini
          api_key_env:
          num_examples_per_title: 10
          temperature:
          reasoning_effort: minimal
          max_retries: 6
          retry_backoff: 5.0
          max_concurrent: 300
          seed: 42
          output_responses: synthetic_data/data/jitter_responses.jsonl
          output_titles: synthetic_data/data/jittered_titles.csv
          metrics_path: synthetic_data/metrics/jitter_summary.json
    outs:
    - path: synthetic_data/data/jitter_responses.jsonl
      hash: md5
      md5: a5548639a5d3d2c304d4fe935596948e
      size: 3988493
    - path: synthetic_data/data/jittered_titles.csv
      hash: md5
      md5: 053a09d3a924c43dc4c5207a43d5287a
      size: 7637127
    - path: synthetic_data/metrics/jitter_summary.json
      hash: md5
      md5: 4ec2edaac3c50ce2a71bdb7e68e010e5
      size: 156
  fine_tuning:
    cmd: python -m fine_tuning.train --params params.yaml
    deps:
    - path: fine_tuning/train.py
      hash: md5
      md5: c09b372d05a3438f8da6c8815b5a7b19
      size: 15109
    - path: fine_tuning/visualize_embedding_space.py
      hash: md5
      md5: e0fb28c4d6df70a866fc34eb376be7f8
      size: 1029
    - path: synthetic_data/data/jittered_titles.csv
      hash: md5
      md5: 053a09d3a924c43dc4c5207a43d5287a
      size: 7637127
    params:
      params.yaml:
        fine_tuning:
          base_model: sentence-transformers/all-MiniLM-L6-v2
          jitter_path: synthetic_data/data/jittered_titles.csv
          dynamic_negatives: true
          num_epochs: 15
          train_batch_size: 192
          negatives_per_positive: 5
          evals_per_epoch: 2
          val_fraction: 0.2
          test_fraction: 0.1
          random_seed: 42
          max_steps:
          tsne_subset_size: 500
          tsne_perplexity: 20
          tsne_learning_rate: 200
          tsne_n_iter: 1000
          model_save_dir: fine_tuning/data/trained_models
          metrics_path: fine_tuning/metrics/training.json
          plot_path: fine_tuning/plots/embedding_tsne.png
    outs:
    - path: fine_tuning/data/datasets/test_ds.csv
      hash: md5
      md5: 7b4d001bc4b3141b09b857eaa1ab7f64
      size: 1143205
    - path: fine_tuning/data/datasets/train_ds.csv
      hash: md5
      md5: 6fb36bbca2d59d48b7fdfd2c3f2130b9
      size: 5198999
    - path: fine_tuning/data/datasets/val_ds.csv
      hash: md5
      md5: ef847f795834d71da3e480b6733e9af0
      size: 1295015
    - path: fine_tuning/data/trained_models
      hash: md5
      md5: 70f84d8d027a65bb5074635e7a1a2125.dir
      size: 636083225
      nfiles: 39
    - path: fine_tuning/metrics/training.json
      hash: md5
      md5: 41f0de1e0a3be1f8e53bf85e057d920a
      size: 488
    - path: fine_tuning/plots/embedding_tsne.png
      hash: md5
      md5: c19a0409ed618cd3fd81248f0ad28b7d
      size: 218999
  publish_model:
    cmd: "python -c \"from pathlib import Path; import shutil; src=Path('fine_tuning/data/trained_models');
      dst=Path('streamlit_app/data/fine_tuned_model'); shutil.rmtree(dst) if dst.exists()
      else None; shutil.copytree(src, dst); print(f'Copied {src} -> {dst}')\"\n"
    deps:
    - path: fine_tuning/data/trained_models
      hash: md5
      md5: 70f84d8d027a65bb5074635e7a1a2125.dir
      size: 636083225
      nfiles: 39
    - path: fine_tuning/metrics/training.json
      hash: md5
      md5: 41f0de1e0a3be1f8e53bf85e057d920a
      size: 488
    outs:
    - path: streamlit_app/data/fine_tuned_model
      hash: md5
      md5: 70f84d8d027a65bb5074635e7a1a2125.dir
      size: 636083225
      nfiles: 39
  prepare_embeddings:
    cmd: python streamlit_app/prepare_embeddings.py
    deps:
    - path: streamlit_app/data/fine_tuned_model
      hash: md5
      md5: 70f84d8d027a65bb5074635e7a1a2125.dir
      size: 636083225
      nfiles: 39
    - path: streamlit_app/data/job_postings.parquet
      hash: md5
      md5: e4f9b3738201cc19c56b717fcff34415
      size: 9216633
    - path: streamlit_app/prepare_embeddings.py
      hash: md5
      md5: 2693c333a3d92bc29fd052dcbf2767e2
      size: 1821
    outs:
    - path: streamlit_app/data/default_embeddings.npy
      hash: md5
      md5: 3da40ccfa188f0986ba3c062d240c4de
      size: 172030592
    - path: streamlit_app/data/fine_tuned_embeddings.npy
      hash: md5
      md5: 3b03c18c608919a39999fae64dab9207
      size: 172030592
